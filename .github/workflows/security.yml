name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

jobs:
  dependency-check:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Run OWASP Dependency Check
        run: |
          ./gradlew dependencyCheckAnalyze --info
      
      - name: Upload dependency check report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: build/reports/dependency-check-report.html
      
      - name: Check for critical vulnerabilities
        run: |
          if [ -f build/reports/dependency-check-report.html ]; then
            # Extract vulnerability count
            CRITICAL_COUNT=$(grep -o "Critical: [0-9]*" build/reports/dependency-check-report.html | grep -o "[0-9]*" | head -1)
            HIGH_COUNT=$(grep -o "High: [0-9]*" build/reports/dependency-check-report.html | grep -o "[0-9]*" | head -1)
            
            echo "Critical vulnerabilities: $CRITICAL_COUNT"
            echo "High vulnerabilities: $HIGH_COUNT"
            
            if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 5 ]; then
              echo "::error::Critical or too many high severity vulnerabilities found"
              echo "::warning::Please review dependencies and update as needed"
              exit 1
            fi
          else
            echo "::warning::Dependency check report not found"
          fi
      
      - name: Create issue for vulnerabilities
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = 'No report available';
            if (fs.existsSync('build/reports/dependency-check-report.html')) {
              report = 'See dependency check report in workflow artifacts';
            }
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Security Vulnerabilities Detected',
              body: `Dependency vulnerability scan detected critical or high severity issues.

              **Details:**
              - Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              - Date: ${new Date().toISOString()}
              - Report: ${report}

              Please review and update dependencies immediately.`,
              labels: ['security', 'vulnerability', 'critical']
            });

  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
          queries: security-extended,security-and-quality
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/java"

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified
      
      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: dependency-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker image
        run: |
          docker build -t pdf-processing-platform:security-scan .
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'pdf-processing-platform:security-scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Run Trivy in table format
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --severity HIGH,CRITICAL \
            pdf-processing-platform:security-scan
      
      - name: Check for critical vulnerabilities
        run: |
          VULNS=$(docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --severity CRITICAL \
            --format json \
            pdf-processing-platform:security-scan | jq '.Results[]?.Vulnerabilities | length' | awk '{s+=$1} END {print s}')
          
          if [ "$VULNS" -gt 0 ]; then
            echo "::error::Found $VULNS critical vulnerabilities in container image"
            exit 1
          fi

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run SpotBugs
        run: |
          ./gradlew spotbugsMain
      
      - name: Upload SpotBugs report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: spotbugs-report
          path: build/reports/spotbugs/
      
      - name: Run Checkstyle
        run: |
          ./gradlew checkstyleMain
      
      - name: Upload Checkstyle report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkstyle-report
          path: build/reports/checkstyle/
      
      - name: Run PMD
        run: |
          ./gradlew pmdMain
      
      - name: Upload PMD report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pmd-report
          path: build/reports/pmd/

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-check, codeql-analysis, secret-scan, container-scan, security-audit]
    if: always()
    
    steps:
      - name: Generate security summary
        run: |
          echo "# Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "## Scan Results" >> security-summary.md
          echo "- Dependency Check: ${{ needs.dependency-check.result }}" >> security-summary.md
          echo "- CodeQL Analysis: ${{ needs.codeql-analysis.result }}" >> security-summary.md
          echo "- Secret Scan: ${{ needs.secret-scan.result }}" >> security-summary.md
          echo "- Container Scan: ${{ needs.container-scan.result }}" >> security-summary.md
          echo "- Security Audit: ${{ needs.security-audit.result }}" >> security-summary.md
          echo "" >> security-summary.md
          echo "## Summary" >> security-summary.md
          
          if [ "${{ needs.dependency-check.result }}" == "success" ] && \
             [ "${{ needs.codeql-analysis.result }}" == "success" ] && \
             [ "${{ needs.secret-scan.result }}" == "success" ] && \
             [ "${{ needs.container-scan.result }}" == "success" ] && \
             [ "${{ needs.security-audit.result }}" == "success" ]; then
            echo "✅ All security checks passed" >> security-summary.md
          else
            echo "❌ Some security checks failed" >> security-summary.md
          fi
      
      - name: Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
      
      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#security-alerts'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,eventName,ref,workflow