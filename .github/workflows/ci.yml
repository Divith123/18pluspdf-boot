name: CI - PDF Processing Platform

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libreoffice \
            tesseract-ocr \
            tesseract-ocr-eng \
            tesseract-ocr-fra \
            tesseract-ocr-spa \
            tesseract-ocr-deu \
            mupdf-tools \
            ghostscript \
            poppler-utils \
            imagemagick
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Build with Gradle
        run: ./gradlew clean build -x test
      
      - name: Run unit tests
        run: ./gradlew test --info
      
      - name: Generate test fixtures
        run: |
          cd src/test/resources/fixtures
          pip3 install reportlab
          python3 generate_test_pdfs.py
          cd ../../../..
      
      - name: Start application in background
        run: |
          ./gradlew bootRun &
          # Wait for application to start
          timeout 60 bash -c 'until curl -s http://localhost:8080/actuator/health > /dev/null; do sleep 2; done' || (echo "Application failed to start" && exit 1)
      
      - name: Run integration tests
        run: ./gradlew test --tests "*IntegrationTest" --info
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: build/reports/tests/test/
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: build/reports/jacoco/test/html/
      
      - name: Check for test failures
        run: |
          if [ -f build/test-results/test/TEST-*.xml ]; then
            failures=$(grep -c 'failure="[^0]' build/test-results/test/TEST-*.xml || true)
            if [ "$failures" -gt 0 ]; then
              echo "::error::$failures test(s) failed"
              exit 1
            fi
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Run dependency check
        run: ./gradlew dependencyCheckAnalyze || true
      
      - name: Upload dependency check report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: build/reports/dependency-check-report.html
      
      - name: Check for critical vulnerabilities
        run: |
          if [ -f build/reports/dependency-check-report.html ]; then
            if grep -q "CRITICAL" build/reports/dependency-check-report.html; then
              echo "::warning::Critical vulnerabilities found in dependencies"
            fi
          fi

  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: pdf-processing-platform:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Test Docker image
        run: |
          docker run -d -p 8080:8080 \
            -e SPRING_PROFILES_ACTIVE=test \
            -e JWT_SECRET=test-secret \
            -e API_KEYS=test-key \
            --name pdf-test \
            pdf-processing-platform:test
          
          sleep 30
          
          if curl -s http://localhost:8080/actuator/health | grep -q "UP"; then
            echo "Docker container health check passed"
          else
            echo "Docker container health check failed"
            docker logs pdf-test
            exit 1
          fi
          
          docker stop pdf-test
          docker rm pdf-test
      
      - name: Save Docker image
        run: docker save pdf-processing-platform:test | gzip > pdf-processing-platform.tar.gz
      
      - name: Upload Docker artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: pdf-processing-platform.tar.gz

  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libreoffice tesseract-ocr mupdf-tools
      
      - name: Generate test fixtures
        run: |
          cd src/test/resources/fixtures
          pip3 install reportlab
          python3 generate_test_pdfs.py
          cd ../../../..
      
      - name: Start application
        run: |
          ./gradlew bootRun &
          timeout 60 bash -c 'until curl -s http://localhost:8080/actuator/health > /dev/null; do sleep 2; done'
      
      - name: Run benchmark
        run: |
          cd performance
          chmod +x benchmark.sh
          ./benchmark.sh
          cd ..
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: performance/results/
      
      - name: Comment benchmark results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'performance/results/benchmark.csv';
            if (fs.existsSync(path)) {
              const data = fs.readFileSync(path, 'utf8');
              const lines = data.split('\n').filter(l => l.trim());
              const avgTime = lines.slice(1).reduce((acc, line) => {
                const parts = line.split(',');
                return acc + parseFloat(parts[2] || 0);
              }, 0) / (lines.length - 1);
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ðŸ“Š **Benchmark Results**\n\nAverage processing time: ${avgTime.toFixed(2)}ms\n\nSee artifacts for detailed results.`
              });
            }

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [test, docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate changelog
        id: changelog
        run: |
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 2>/dev/null || git rev-list --max-parents=0 HEAD)..HEAD >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      
      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            ## Changes
            ${{ env.CHANGELOG }}
            
            ## Docker Image
            `ghcr.io/${{ github.repository }}:v${{ github.run_number }}`
            
            ## Artifacts
            See CI artifacts for test results and coverage reports.
          draft: false
          prerelease: false
      
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:v${{ github.run_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Deploy to Production (Webhook)
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DEPLOY_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/deployments \
            -d '{"ref":"main","environment":"production","auto_merge":false,"required_contexts":[]}'