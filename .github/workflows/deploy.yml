name: Deploy - PDF Processing Platform

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version to deploy (leave empty for latest)'
        required: false
        type: string

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'staging'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: pdf-processing-platform
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
      
      - name: Deploy to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: task-definition-staging.json
          service: pdf-processing-staging
          cluster: pdf-processing-cluster
          wait-for-service-stability: true
      
      - name: Run smoke tests
        run: |
          sleep 30
          curl -f https://staging-pdf-api.chnindia.com/actuator/health || exit 1
          curl -f -H "X-API-Key: ${{ secrets.STAGING_API_KEY }}" \
            https://staging-pdf-api.chnindia.com/api/pdf/health || exit 1
      
      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate production readiness
        run: |
          echo "Running production deployment checks..."
          # Check if version is provided or use latest
          if [ -z "${{ github.event.inputs.version }}" ]; then
            echo "Deploying latest version"
          else
            echo "Deploying version: ${{ github.event.inputs.version }}"
          fi
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: pdf-processing-platform
          IMAGE_TAG: ${{ github.event.inputs.version || github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
      
      - name: Create deployment
        uses: chrnorm/deployment-action@v2
        id: deployment
        with:
          token: '${{ github.token }}'
          environment: production
          description: 'Production deployment of PDF Processing Platform'
      
      - name: Deploy to ECS (Blue-Green)
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: task-definition-production.json
          service: pdf-processing-production
          cluster: pdf-processing-cluster
          wait-for-service-stability: true
      
      - name: Run health checks
        run: |
          echo "Waiting for service to stabilize..."
          sleep 60
          
          # Health check
          for i in {1..10}; do
            if curl -f https://pdf-api.chnindia.com/actuator/health; then
              echo "Health check passed"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "Health check failed"
              exit 1
            fi
            sleep 10
          done
      
      - name: Run smoke tests
        run: |
          # Test basic functionality
          curl -f -H "X-API-Key: ${{ secrets.PRODUCTION_API_KEY }}" \
            -F "file=@src/test/resources/fixtures/test_files/simple.pdf" \
            https://pdf-api.chnindia.com/api/pdf/extract-text || exit 1
      
      - name: Update deployment status
        uses: chrnorm/deployment-status@v2
        if: always()
        with:
          token: '${{ github.token }}'
          state: ${{ job.status }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
      
      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#production-deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow

  rollback:
    name: Rollback Production
    runs-on: ubuntu-latest
    if: failure() && github.event.inputs.environment == 'production'
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Rollback to previous version
        run: |
          echo "Initiating rollback..."
          # This would typically involve updating ECS service to previous task definition
          # Implementation depends on your rollback strategy
          aws ecs update-service \
            --cluster pdf-processing-cluster \
            --service pdf-processing-production \
            --task-definition pdf-processing-production-previous
      
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#production-deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          text: 'ðŸš¨ Production deployment failed - rollback initiated'

  migrate-database:
    name: Database Migration
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production'
    needs: deploy-production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
        run: |
          echo "Running database migrations..."
          ./gradlew flywayMigrate
      
      - name: Verify migration
        run: |
          ./gradlew flywayInfo

  notify-complete:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [deploy-production, migrate-database]
    if: always()
    
    steps:
      - name: Send completion notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ needs.deploy-production.result }}
          channel: '#production-deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow